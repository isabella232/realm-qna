<h2>Realm Question</h2>

<a href="/write">Write</a>

<h2>currentUser: {{currentUser}}</h2>

{{#each questions}}
<div>
  <h3>author: {{author.id}}</h3>
  <p>question: {{question}}</p>
  <p>vote: {{vote.length}}</p>
  {{#ifCond author.id ../currentUser}}
    <button id="edit" onclick="editQuestion(this.parentNode, {{id}}, '{{question}}' )">edit</button>
    <button id="delete" onclick="deleteQuestion(this.parentNode, {{id}}, '{{question}}' )">delete</button>
  {{/ifCond}}
  
  <button id="vote" onclick="voteQuestion(this.parentNode, {{id}}, 'true')">vote</button>
  
  {{#each vote}}
    {{#ifCond id ../../currentUser}}
      <button id="unvote" onclick="voteQuestion(this.parentNode, {{../id}},  'false')">unvote</button>
    {{/ifCond}}
  {{/each}}
  
</div>
{{/each}}

<script>
function editQuestion(targetDiv, qid, question) {
  while (targetDiv.hasChildNodes() ) {
    targetDiv.removeChild(targetDiv.firstChild)
  }

  var form = document.createElement("form");
  form.setAttribute("method", "post");

  var hiddenForm = document.createElement("textarea")
  hiddenForm.setAttribute('type', "text")
  hiddenForm.setAttribute('name', "qid")
  hiddenForm.value = qid
  hiddenForm.style.display = 'none';

  var inputForm = document.createElement("textarea")
  inputForm.setAttribute('type', "text")
  inputForm.setAttribute('name', "question")
  inputForm.innerHTML = question

  var submitButton = document.createElement("button")
  submitButton.setAttribute('type', "submit")
  submitButton.innerHTML = "Submit"

  form.appendChild(hiddenForm)
  form.appendChild(inputForm)
  form.appendChild(submitButton)
  targetDiv.appendChild(form)
}

function deleteQuestion(targetDiv, qid, question) {
  while (targetDiv.hasChildNodes() ) {
    targetDiv.removeChild(targetDiv.firstChild)
  }

  var confirmText = document.createElement("h3")
  confirmText.innerHTML = "Are you really want to delete this question?"

  var cancelButton = document.createElement("button")
  cancelButton.setAttribute('type', "button")
  cancelButton.setAttribute('onclick', "location.href='/'")
  cancelButton.innerHTML = "Cancel"

  var delForm = document.createElement("form")
  delForm.setAttribute("method", "post")

  var hiddenForm = document.createElement("textarea")
  hiddenForm.setAttribute('type', "text")
  hiddenForm.setAttribute('name', "qid")
  hiddenForm.value = qid
  hiddenForm.style.display = 'none';

  var deleteButton = document.createElement("button")
  deleteButton.setAttribute('type', "submit")
  deleteButton.innerHTML = "Delete"

  delForm.appendChild(hiddenForm)
  delForm.appendChild(cancelButton)
  delForm.appendChild(deleteButton)

  targetDiv.appendChild(confirmText)
  targetDiv.appendChild(delForm)
}

function voteQuestion(targetDiv, vid, isVote) {
  var hiddenForm = document.createElement("textarea")
  hiddenForm.setAttribute('type', "text")
  hiddenForm.setAttribute('name', "vid")
  hiddenForm.value = vid
  hiddenForm.style.display = 'none';

  var hiddenFormVote = document.createElement("textarea")
  hiddenFormVote.setAttribute('type', "text")
  hiddenFormVote.setAttribute('name', "isVote")
  
  if (isVote == "true") {
    hiddenFormVote.value = "true"
  }
  hiddenFormVote.style.display = 'none';
  
  var voteForm = document.createElement("form")
  voteForm.setAttribute("method", "post")
  voteForm.appendChild(hiddenForm)
  voteForm.appendChild(hiddenFormVote)
  
  targetDiv.appendChild(voteForm)
  voteForm.submit()
  
  console.log("voteForm.submit()")
}

</script>
